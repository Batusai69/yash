#!/bin/sh

# Manually written configuration script for yash
# (C) 2007-2008 magicant
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

makefile="Makefile"
makefilein="Makefile.in"
configlog="config.log"
configh="config.h"
versionh="version.h"
tempsrc=".temp.c"
tempo=".temp.o"
tempout="./.temp.out"

cc="${CC:-c99}"
cflags="${CFLAGS--O1 -g}"
ldflags="${LDFLAGS}"
ldlibs="${LDLIBS--lm}"
target="yash"
package="yash"
version="2.0b0"
copyrightyear="2007-2008"

# all source files in this directory
sources="alias.c alias.h arith.c arith.h builtin.c builtin.h common.h exec.c exec.h expand.c expand.h hashtable.c hashtable.h job.c job.h input.c input.h option.c option.h mksignum.c parser.c parser.h path.c path.h plist.c plist.h redir.c redir.h resource.c resource.h sig.c sig.h siglist.h strbuf.c strbuf.h util.c util.h variable.c variable.h wfnmatch.c wfnmatch.h yash.h yash.c" 

# object files to be linked as `yash'
objs="option.o util.o strbuf.o plist.o hashtable.o wfnmatch.o path.o input.o alias.o parser.o variable.o sig.o arith.o expand.o redir.o job.o resource.o builtin.o exec.o yash.o"

# object file to be linked as `mksignum'
mksignumobjs="mksignum.o"

help="no"
gcc=""
debug="no"
unset prefix eprefix bindir
umask u=rwx,go=rx

# parse options
for i
do
    case "$i" in
	-h|--help)
	    help="yes" ;;
	-d|--debug)
	    debug="yes" ;;
	--prefix=*)
	    prefix="${i#--prefix=}" ;;
	--exec-prefix=*)
	    execprefix="${i#--exec-prefix=}" ;;
	--bindir=*)
	    bindir="${i#--bindir=}" ;;
	?*=*)
	    # parse variable assignment
	    if echo "$i" |
		LC_ALL=C grep -E "^[[:alpha:]][[:alnum:]]*=" >/dev/null
	    then
		eval "${i%%=*}="'${i#*=}'
	    else
		echo "$0: $i: unknown argument" >&2
		exit 1
	    fi
	    ;;
	*)
	    echo "$0: $i: unknown argument" >&2
	    exit 1
    esac
done

if [ x"${help}" = x"yes" ]
then
    cat <<END
Usage: ./configure [options...]

Available options:
  --debug                configure for debug build (GCC required)
  --no-undefined         inhibit any undefined operation

Installation options:
  --prefix=PREFIX        install architecture-independent files in PREFIX
                         [/usr/local]
  --exec-prefix=EPREFIX  install architecture-dependent files in EPREFIX
                         [PREFIX]
  --bindir=DIR           install executable in DIR [EPREFIX/bin]

Influential environment variables:
  CC, CFLAGS, CADDS, LDFLAGS, LDADDS, LDLIBS, INSTALL_PROGRAM
END
    exit 0
fi


trap 'rm -f "${tempsrc}" "${tempo}" "${tempout}"' EXIT

exec 5>"${configlog}"
exec 6>"${configh}"

echo "===== Configuration log: generated by configure =====" >&5
echo >&5
date >&5
echo >&5
echo "# Invocation command line was:" >&5
echo "%" $(for i in "$0" "$@"; do echo "$i"; done | sed -e '
/[^[:alnum:]./=-]/ {
s/'"'"'/'"'\\''"'/g
s/\(.*\)/'"'"'\1'"'"'/
}') >&5
echo >&5
echo "#" uname -n = $(uname -n) >&5
echo "#" uname -m = $(uname -m) >&5
echo "#" uname -r = $(uname -r) >&5
echo "#" uname -s = $(uname -s) >&5
echo "#" uname -v = $(uname -v) >&5
echo >&5
echo "#" PATH="${PATH}" >&5
echo >&5
echo >&5

echo "/* ${configh}: generated by configure */" >&6

checking () {
    printf "%s" "checking $1... "
    echo >&5
    echo "# checking $1..." >&5
}
checkby () {
    echo "%" "$@" >&5
    eval "$@" >&5 2>&1
}
trymake () {
    echo "%" ${cc} ${cflags} ${CADDS} ${ldflags} ${LDADDS} -o "${tempout}" \
	"${tempsrc}" "$@" ${ldlibs} >&5
    ${cc} ${cflags} ${CADDS} ${ldflags} ${LDADDS} -o "${tempout}" \
	"${tempsrc}" "$@" ${ldlibs} >&5 2>&1
}
trycompile () {
    echo "%" ${cc} ${cflags} ${CADDS} -c -o "${tempo}" "${tempsrc}" "$@" >&5
    ${cc} ${cflags} ${CADDS} -c -o "${tempo}" "${tempsrc}" "$@" >&5 2>&1
}
trylink () {
    echo "%" ${cc} ${ldflags} ${LDADDS} -o "${tempout}" \
	"${tempo}" "$@" ${ldlibs} >&5
    ${cc} ${ldflags} ${LDADDS} -o "${tempout}" \
	"${tempo}" "$@" ${ldlibs} >&5 2>&1
}
tryexec () {
    checkby "${tempout}"
}
checked () {
    echo "$1"
    echo "# result: $1" >&5
}
defconfigh () {
    echo "#define" $1 ${2-1} >&6
    echo "# defining $1='${2-1}' in ${configh}" >&5
}
fail () {
    echo "configuration failed" >&2
}

# check OS type
checking "operation system"
ostype=$(uname -s | tr "[:upper:]" "[:lower:]")
checked "${ostype}"
case "${ostype}" in
    darwin)
	defconfigh "_DARWIN_C_SOURCE"
	;;
esac

# check POSIX conformance
checking "POSIX conformance"
posix=$(getconf _POSIX_VERSION 2>/dev/null)
if [ -n "${posix}" ] && [ x"${posix}" != x"undefined" ]
then
    checked "${posix}"
    if [ "${posix}" -lt 200112 ]
    then
	posix=""
    fi
else
    posix=""
    checked "no"
fi

# check SUS conformance
if [ -n "${posix}" ]
then
    checking "SUS conformance"
    xopen=$(getconf _XOPEN_VERSION 2>/dev/null)
    if [ -n "${xopen}" ] && [ x"${xopen}" != x"undefined" ]
    then
	checked "${xopen}"
	if [ "${xopen}" -lt 600 ]
	then
	    xopen=""
	fi
    else
	xopen=""
	checked "no"
    fi
fi

# determine the compiler and its flags
if [ x"${debug}" = x"yes" ]
then
    checking "whether GCC is available"
    if checkby "${CC:-gcc} --version | grep -i gcc"
    then
	checked "yes"
	gcc="yes" cc="${CC:-gcc}"
	cflags="-std=c99 -O1 -fno-inline -ggdb -Wall -Wextra"
    else
	checked "no"
	echo "--debug option specified but GCC is not available" 2>&1
	fail
    fi
fi
if [ x"${debug}" = x"no" ]
then
    defconfigh "NDEBUG"
fi

# check if the compiler works
checking "whether the compiler works"
cat >"${tempsrc}" <<END
int main() { return 0; }
END
if trymake && tryexec
then
    checked "yes"
else
    checked "no"
    fail
fi

# check if the compiler accepts the -O2 option if we are not debugging
if [ x"${debug}" = x"no" ]
then
    checking "whether the compiler accepts -O2 flag"
    cat >"${tempsrc}" <<END
int main() { return 0; }
END
    savecflags=${cflags}
    if cflags="-O2 -g" trycompile
    then
	checked "yes"
    else
	checked "no"
	cflags=${savecflags}
    fi
    unset savecflags
fi

# check whether system has /proc/self/exe
checking "whether system has /proc/self/exe"
if [ -x /proc/self/exe ]
then
    checked "yes"
    defconfigh "HAVE_PROC_SELF_EXE"
else
    checked "no"
fi

# check for strnlen
checking "for strnlen"
cat >"${tempsrc}" <<END
#include <stddef.h>
size_t strnlen(const char*, size_t);
int main() { return (int) strnlen("", 1); }
END
if trymake
then
    checked "yes"
    defconfigh "HAVE_STRNLEN"
else
    checked "no"
fi

# check for wcsnlen
checking "for wcsnlen"
cat >"${tempsrc}" <<END
#include <stddef.h>
size_t wcsnlen(const wchar_t*, size_t);
int main() { return (int) wcsnlen(L"", 1); }
END
if trymake
then
    checked "yes"
    defconfigh "HAVE_WCSNLEN"
else
    checked "no"
fi

# check for mkstemp
checking "for mkstemp"
cat >"${tempsrc}" <<END
#define _POSIX_C_SOURCE 200112
#define _XOPEN_SOURCE   600
#include <stdlib.h>
int main() { return mkstemp((char []) { "" }); }
END
if trymake
then
    checked "yes"
    defconfigh "HAVE_MKSTEMP"
else
    checked "no"
fi

# check for strsignal
checking "for strsingal"
cat >"${tempsrc}" <<END
#define _POSIX_C_SOURCE 200112
#include <stdio.h>
#include <signal.h>
extern char *strsignal(int);
int main() { printf("%s\n", strsignal(SIGKILL)); }
END
if trymake
then
    checked "yes"
    defconfigh "HAVE_STRSIGNAL"
else
    checked "no"
fi

# check for paths.h
checking "for paths.h"
cat >"${tempsrc}" <<END
#include <paths.h>
#include <stdio.h>
int main() { printf("%s\n", _PATH_BSHELL); }
END
if trycompile
then
    checked "yes"
    defconfigh "HAVE_PATHS_H"
else
    checked "no"
fi

# check if getcwd accepts (NULL,0) as argument
checking "if getcwd(NULL,0) returns malloc'ed string"
cat >"${tempsrc}" <<END
#include <errno.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
char *xgetcwd(void) {
    size_t pwdlen = 40;
    char *pwd = malloc(pwdlen);
    if (!pwd) return NULL;
    while (getcwd(pwd, pwdlen) == NULL) {
	if (errno == ERANGE) {
	    pwdlen *= 2;
	    pwd = realloc(pwd, pwdlen);
	    if (!pwd) return NULL;
	} else {
	    free(pwd);
	    return NULL;
	}
    }
    return pwd;
}
int main(void) {
    char *wd1 = getcwd(NULL, 0);
    if (!wd1) return 1;
    char *wd2 = xgetcwd();
    if (!wd2 || strcmp(wd1, wd2) != 0) return 1;
    char *wd11 = realloc(wd1, strlen(wd1) + 10);
    if (!wd11 || strcmp(wd11, wd2) != 0) return 1;
    free(wd11);
}
END
if trymake && tryexec
then
    checked "yes"
    defconfigh "GETCWD_AUTO_MALLOC"
else
    checked "no"
fi

# check for getrlimit and setrlimit
checking "for getrlimit and setrlimit"
cat >"${tempsrc}" <<END
#define _XOPEN_SOURCE 600
#include <sys/resource.h>
int main() {
struct rlimit l;
getrlimit(RLIMIT_FSIZE, &l);
setrlimit(RLIMIT_FSIZE, &l);
}
END
if trymake
then
    checked "yes"
    defconfigh "HAVE_RLIMIT"
    rlimit="yes"
else
    checked "no"
    rlimit=""
fi

# check for RLIMIT_***
if [ x"${rlimit}" = x"yes" ]
then
    for i in LOCKS MEMLOCK MSGQUEUE NICE NPROC RSS RTPRIO SIGPENDING 
    do
	checking "for RLIMIT_${i}"
	cat >"${tempsrc}" <<END
#include "${configh}"
#include <sys/resource.h>
int main() { return RLIMIT_${i} == RLIMIT_AS; getrlimit(RLIMIT_${i}, 0); }
END
	if trymake && tryexec
	then
	    checked "yes"
	    defconfigh "HAVE_RLIMIT_${i}"
	else
	    checked "no"
	fi
    done
fi


cflags="${cflags} -D HAVE_CONFIG_H"

CC="${CC-${cc}}"
CFLAGS="${CFLAGS-${cflags}} ${CADDS}"
LDFLAGS="${LDFLAGS-${ldflags}} ${LDADDS}"
LDLIBS="${LDLIBS-${ldlibs}}"
SOURCES="${sources}"
OBJS="${objs}"
MKSIGNUMOBJS="${mksignumobjs}"
PACKAGE="${package}"
TARGET="${target}"
VERSION="${version}"
INSTALL_PROGRAM="${INSTALL_PROGRAM-sh ./install-sh}"
PREFIX="${prefix-/usr/local}"
EPREFIX="${eprefix-${PREFIX}}"
if [ x"${PREFIX}" = x"/" ]; then PREFIX=""; fi
if [ x"${EPREFIX}" = x"/" ]; then EPREFIX=""; fi
BINDIR="${bindir-${EPREFIX}/bin}"
DISTDIR=$(echo $PACKAGE $VERSION | sed -e 's/[[:space:]]/-/g')

# create Makefile from Makefile.in
echo "creating ${makefile}"
{
    echo "# ${makefile}: generated by configure"

    sed -e "
	s!@CC@!${CC}!g
	s!@CFLAGS@!${CFLAGS}!g
	s!@LDFLAGS@!${LDFLAGS}!g
	s!@LDLIBS@!${LDLIBS}!g
	s!@SOURCES@!${SOURCES}!g
	s!@OBJS@!${OBJS}!g
	s!@MKSIGNUMOBJS@!${MKSIGNUMOBJS}!g
	s!@PACKAGE@!${PACKAGE}!g
	s!@TARGET@!${TARGET}!g
	s!@VERSION@!${VERSION}!g
	s!@INSTALL_PROGRAM@!${INSTALL_PROGRAM}!g
	s!@PREFIX@!${PREFIX}!g
	s!@EPREFIX@!${EPREFIX}!g
	s!@BINDIR@!${BINDIR}!g
	s!@DISTDIR@!${DISTDIR}!g
	" "${makefilein}"

    echo "# dependencies resolved by makedepend"

    for i in ${SOURCES}
    do case "$i" in
	*.c) echo "$i"
    esac done | xargs sh ./makedepend
} > "${makefile}"

echo >&5
echo "===== Output variables =====" >&5
echo CC="'${CC}'" >&5
echo CFLAGS="'${CFLAGS}'" >&5
echo LDFLAGS="'${LDFLAGS}'" >&5
echo LDLIBS="'${LDLIBS}'" >&5
echo SOURCES="'${SOURCES}'" >&5
echo OBJS="'${OBJS}'" >&5
echo MKSIGNUMOBJS="'${MKSIGNUMOBJS}'" >&5
echo PACKAGE="'${PACKAGE}'" >&5
echo TARGET="'${TARGET}'" >&5
echo VERSION="'${VERSION}'" >&5
echo INSTALL_PROGRAM="'${INSTALL_PROGRAM}'" >&5
echo PREFIX="'${PREFIX}'" >&5
echo EPREFIX="'${EPREFIX}'" >&5
echo BINDIR="'${BINDIR}'" >&5
echo DISTDIR="'${DISTDIR}'" >&5


# create version.h
echo "creating ${versionh}"
cat >"${versionh}" <<END
/* ${versionh}: generated by configure */
#ifndef VERSION_H
#define VERSION_H
#define PACKAGE_NAME "${PACKAGE}"
#define PACKAGE_STRING "${PACKAGE} ${VERSION}"
#define PACKAGE_VERSION "${VERSION}"
#define PACKAGE_COPYRIGHT "Copyright (C) ${copyrightyear} magicant"
#endif
END


# print warning if POSIX conformance is missing
if [ -z "${posix}" ]; then
    echo "WARNING: yash is designed for systems that conform to POSIX.1-2001"
    echo "         but your system does not"
fi


# vim: set ts=8 sts=4 sw=4 noet:
